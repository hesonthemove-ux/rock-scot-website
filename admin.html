<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Discount Manager | ROCK.SCOT</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --orange:#FF6600; --gold:#FFD700; --black:#000; --dark:#0a0a0a; --mid:#111; --white:#FFF; --text-dim:rgba(255,255,255,0.65); --border:rgba(255,102,0,0.25); }
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Barlow',sans-serif; background:var(--dark); color:var(--white); min-height:100vh; }
        header { background:#000; border-bottom:2px solid var(--orange); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
        .logo { height:45px; }
        .admin-label { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; color:var(--orange); letter-spacing:0.1em; }
        .container { max-width:1000px; margin:0 auto; padding:2rem; }
        h2 { font-family:'Bebas Neue',sans-serif; font-size:2.5rem; color:var(--orange); letter-spacing:0.05em; margin-bottom:1.5rem; }
        .card { background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:4px; padding:2rem; margin-bottom:2rem; }
        .card h3 { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; color:var(--white); margin-bottom:1.5rem; }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
        .form-group { margin-bottom:1.25rem; }
        label { display:block; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:0.9rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--orange); margin-bottom:0.4rem; }
        input, select { width:100%; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.15); color:var(--white); padding:0.8rem 1rem; font-family:'Barlow',sans-serif; font-size:0.95rem; border-radius:2px; outline:none; transition:border-color 0.2s; }
        input:focus, select:focus { border-color:var(--orange); }
        select option { background:#222; }
        .btn { background:var(--orange); color:var(--white); border:none; padding:0.85rem 2rem; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:1rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:background 0.2s; clip-path:polygon(0 0, calc(100% - 10px) 0, 100% 100%, 10px 100%); }
        .btn:hover { background:#FF4400; }
        .btn-outline { background:transparent; color:var(--orange); border:1px solid var(--orange); padding:0.5rem 1rem; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:0.85rem; letter-spacing:0.08em; text-transform:uppercase; cursor:pointer; transition:all 0.2s; }
        .btn-outline:hover { background:var(--orange); color:var(--white); }
        .btn-approve { background:#4ade80; color:#000; border:none; padding:0.4rem 0.9rem; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:0.8rem; letter-spacing:0.05em; text-transform:uppercase; cursor:pointer; }
        .btn-reject  { background:#f87171; color:#000; border:none; padding:0.4rem 0.9rem; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:0.8rem; letter-spacing:0.05em; text-transform:uppercase; cursor:pointer; }
        table { width:100%; border-collapse:collapse; }
        th { background:rgba(255,102,0,0.1); color:var(--orange); font-family:'Barlow Condensed',sans-serif; letter-spacing:0.08em; text-transform:uppercase; font-size:0.85rem; padding:0.75rem 1rem; text-align:left; border-bottom:2px solid var(--orange); }
        td { padding:0.75rem 1rem; border-bottom:1px solid rgba(255,255,255,0.06); color:var(--text-dim); font-size:0.9rem; }
        tr:last-child td { border-bottom:none; }
        .badge { display:inline-block; padding:0.2rem 0.6rem; font-family:'Barlow Condensed',sans-serif; font-size:0.75rem; letter-spacing:0.05em; text-transform:uppercase; border-radius:2px; }
        .badge-pending  { background:rgba(253,224,71,0.15); color:#fde047; border:1px solid #fde047; }
        .badge-approved { background:rgba(74,222,128,0.15); color:#4ade80; border:1px solid #4ade80; }
        .msg { padding:0.75rem 1rem; border-radius:2px; margin-top:1rem; font-family:'Barlow Condensed',sans-serif; font-size:1rem; display:none; }
        .msg.success { background:rgba(74,222,128,0.1); border:1px solid #4ade80; color:#4ade80; }
        .msg.error   { background:rgba(248,113,113,0.1); border:1px solid #f87171; color:#f87171; }
        .empty-row td { text-align:center; color:rgba(255,255,255,0.3); padding:2rem; }
        .auth-wall { max-width:400px; margin:6rem auto; padding:3rem; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:4px; text-align:center; }
        .auth-wall h2 { font-size:2rem; margin-bottom:1rem; }
        .auth-wall p { color:var(--text-dim); margin-bottom:2rem; }
    </style>
</head>
<body>

    <header>
        <img src="assets/images/logo.png" alt="ROCK.SCOT" class="logo">
        <span class="admin-label">⚙ Admin — Discount Manager</span>
        <a href="admin-dashboard.html" style="color:var(--orange);font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;text-decoration:none;">Full Dashboard →</a>
    </header>

    <!-- AUTH WALL (shown if no service key) -->
    <div class="auth-wall" id="auth-wall" style="display:none">
        <h2>Admin Access</h2>
        <p>Enter your service role key to access the discount manager.</p>
        <div class="form-group">
            <label>Service Role Key</label>
            <input type="password" id="service-key-input" placeholder="eyJhbG...">
        </div>
        <button class="btn" onclick="setServiceKey()">Unlock →</button>
    </div>

    <div class="container" id="main-content">
        <h2>Discount Code Manager</h2>

        <!-- CREATE NEW DISCOUNT -->
        <div class="card">
            <h3>Create New Discount Code</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Code *</label>
                    <input type="text" id="new-code" placeholder="e.g. SPRING50" style="text-transform:uppercase">
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="new-type">
                        <option value="fixed">Fixed Amount (£)</option>
                        <option value="percent">Percentage (%)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Value *</label>
                    <input type="number" id="new-value" placeholder="e.g. 50" min="1">
                </div>
                <div class="form-group">
                    <label>Note (optional)</label>
                    <input type="text" id="new-note" placeholder="e.g. Spring promo 2026">
                </div>
            </div>
            <button class="btn" onclick="createDiscount()">Create Discount Code →</button>
            <div id="create-msg" class="msg"></div>
        </div>

        <!-- PENDING APPROVALS -->
        <div class="card">
            <h3>Pending Approval</h3>
            <table>
                <thead>
                    <tr><th>Code</th><th>Type</th><th>Value</th><th>Note</th><th>Created</th><th>Action</th></tr>
                </thead>
                <tbody id="pending-tbody">
                    <tr class="empty-row"><td colspan="6">Loading…</td></tr>
                </tbody>
            </table>
        </div>

        <!-- ALL DISCOUNTS -->
        <div class="card">
            <h3>All Discount Codes</h3>
            <table>
                <thead>
                    <tr><th>Code</th><th>Type</th><th>Value</th><th>Status</th><th>Note</th><th>Created</th></tr>
                </thead>
                <tbody id="all-tbody">
                    <tr class="empty-row"><td colspan="6">Loading…</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // ⚠️ SERVICE ROLE KEY — Keep secret! Never commit to git.
    // Set via the auth wall below or hardcode here (local use only)
    let SERVICE_KEY = localStorage.getItem('rs_admin_key') || '';
    const SUPABASE_URL = 'https://pwzeapvopeeoahpyicdm.supabase.co';

    let sb = null;
    function initSB(key) {
        sb = window.supabase.createClient(SUPABASE_URL, key, {
            auth: { autoRefreshToken: false, persistSession: false }
        });
    }

    // Auth wall
    if (!SERVICE_KEY) {
        document.getElementById('auth-wall').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';
    } else {
        initSB(SERVICE_KEY);
        loadAll();
    }

    function setServiceKey() {
        const key = document.getElementById('service-key-input').value.trim();
        if (!key) return alert('Please enter your service role key');
        localStorage.setItem('rs_admin_key', key);
        SERVICE_KEY = key;
        initSB(key);
        document.getElementById('auth-wall').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        loadAll();
    }

    // Create discount
    async function createDiscount() {
        const code  = document.getElementById('new-code').value.toUpperCase().trim();
        const type  = document.getElementById('new-type').value;
        const value = parseFloat(document.getElementById('new-value').value);
        const note  = document.getElementById('new-note').value.trim() || null;
        const msg   = document.getElementById('create-msg');

        if (!code || !value) { showMsg(msg, 'error', '❌ Code and value are required.'); return; }

        const payload = {
            p_code:         code,
            p_amount_pence: type === 'fixed'   ? Math.round(value * 100) : null,
            p_percent_off:  type === 'percent' ? value : null,
            p_note:         note
        };

        try {
            const { data, error } = await sb.rpc('create_discount_code', payload);
            if (error) throw error;
            showMsg(msg, 'success', '✅ Discount code created: ' + code + ' (pending approval)');
            document.getElementById('new-code').value  = '';
            document.getElementById('new-value').value = '';
            document.getElementById('new-note').value  = '';
            loadAll();
        } catch (e) {
            showMsg(msg, 'error', '❌ Error: ' + e.message);
        }
    }

    // Load pending
    async function loadPending() {
        const tbody = document.getElementById('pending-tbody');
        try {
            const { data, error } = await sb.rpc('get_pending_discounts');
            if (error) throw error;
            if (!data || !data.length) {
                tbody.innerHTML = '<tr class="empty-row"><td colspan="6">No pending discounts</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(d => `
                <tr>
                    <td><strong style="color:var(--white)">${d.code}</strong></td>
                    <td>${d.amount_pence ? 'Fixed' : 'Percent'}</td>
                    <td>${d.amount_pence ? '£' + (d.amount_pence/100).toFixed(2) : d.percent_off + '%'}</td>
                    <td>${d.note || '—'}</td>
                    <td>${new Date(d.created_at).toLocaleDateString('en-GB')}</td>
                    <td style="display:flex;gap:0.5rem">
                        <button class="btn-approve" onclick="approveDiscount('${d.id}')">✓ Approve</button>
                        <button class="btn-reject"  onclick="rejectDiscount('${d.id}')">✕ Reject</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6">Error loading: ' + e.message + '</td></tr>';
        }
    }

    // Load all
    async function loadAll() {
        await loadPending();
        const tbody = document.getElementById('all-tbody');
        try {
            const { data, error } = await sb.from('discounts').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            if (!data || !data.length) {
                tbody.innerHTML = '<tr class="empty-row"><td colspan="6">No discount codes yet</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(d => `
                <tr>
                    <td><strong style="color:var(--white)">${d.code}</strong></td>
                    <td>${d.amount_pence ? 'Fixed' : 'Percent'}</td>
                    <td>${d.amount_pence ? '£' + (d.amount_pence/100).toFixed(2) : (d.percent_off || '—') + (d.percent_off ? '%' : '')}</td>
                    <td>${d.approved_at ? '<span class="badge badge-approved">Approved</span>' : '<span class="badge badge-pending">Pending</span>'}</td>
                    <td>${d.note || '—'}</td>
                    <td>${new Date(d.created_at).toLocaleDateString('en-GB')}</td>
                </tr>
            `).join('');
        } catch (e) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6">Error: ' + e.message + '</td></tr>';
        }
    }

    async function approveDiscount(id) {
        if (!confirm('Approve this discount code?')) return;
        try {
            const { error } = await sb.rpc('approve_discount', { p_discount_id: id, p_approved_by: null, p_note: 'Approved via admin panel' });
            if (error) throw error;
            loadAll();
        } catch (e) { alert('Error: ' + e.message); }
    }

    async function rejectDiscount(id) {
        if (!confirm('Delete this discount code?')) return;
        try {
            const { error } = await sb.from('discounts').delete().eq('id', id);
            if (error) throw error;
            loadAll();
        } catch (e) { alert('Error: ' + e.message); }
    }

    function showMsg(el, type, text) {
        el.textContent = text;
        el.className = 'msg ' + type;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }
    </script>
</body>
</html>
