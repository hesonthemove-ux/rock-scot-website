<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROCK.SCOT Admin Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: #1a1a1a;
            border-right: 2px solid #FF6600;
            padding: 2rem 0;
            overflow-y: auto;
        }
        
        .logo {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid #333;
            margin-bottom: 1rem;
        }
        
        .logo h1 {
            color: #FF6600;
            font-size: 1.5rem;
        }
        
        .nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(255, 102, 0, 0.1);
            border-left-color: #FF6600;
        }
        
        .nav-item.active {
            background: rgba(255, 102, 0, 0.2);
            border-left-color: #FF6600;
        }
        
        /* Main content */
        .main {
            margin-left: 250px;
            padding: 2rem;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .header {
            margin-bottom: 2rem;
        }
        
        .header h2 {
            color: #FF6600;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #FF6600;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #FF6600;
        }
        
        .stat-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .stat-change.positive { color: #00ff88; }
        .stat-change.negative { color: #ff4444; }
        
        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
        }
        
        th {
            background: rgba(255, 102, 0, 0.2);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #FFD700;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 1rem;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FF6600;
        }
        
        button {
            padding: 0.75rem 2rem;
            background: #FF6600;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #FF8833;
            transform: translateY(-2px);
        }
        
        button.secondary {
            background: #333;
        }
        
        button.secondary:hover {
            background: #444;
        }
        
        /* Badges */
        .badge {
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-pending { background: #FFA500; color: #000; }
        .badge-approved { background: #00ff88; color: #000; }
        .badge-paid { background: #00ff88; color: #000; }
        .badge-active { background: #0066CC; color: #fff; }
        .badge-cancelled { background: #ff4444; color: #fff; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 10px;
            border: 2px solid #FF6600;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333;
        }
        
        .modal-header h3 {
            color: #FF6600;
        }
        
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #FF6600;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>ROCK.SCOT</h1>
            <p style="color: #999; font-size: 0.85rem;">Admin Dashboard</p>
        </div>
        
        <div class="nav-item active" onclick="showPage('dashboard')">
            üìä Dashboard
        </div>
        <div class="nav-item" onclick="showPage('analytics')">
            üìà Analytics
        </div>
        <div class="nav-item" onclick="showPage('bookings')">
            üìÖ Bookings
        </div>
        <div class="nav-item" onclick="showPage('invoices')">
            üí∞ Invoices
        </div>
        <div class="nav-item" onclick="showPage('customers')">
            üë• Customers
        </div>
        <div class="nav-item" onclick="showPage('capacity')">
            üì° Capacity
        </div>
        <div class="nav-item" onclick="showPage('discounts')">
            üéüÔ∏è Discounts
        </div>
        <div class="nav-item" onclick="showPage('emails')">
            ‚úâÔ∏è Emails
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main">
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="header">
                <h2>Dashboard</h2>
                <p style="color: #999;">Overview of your advertising business</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="total-revenue">¬£0</div>
                    <div class="stat-change positive" id="revenue-change">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Campaigns</div>
                    <div class="stat-value" id="active-bookings">‚Äî</div>
                    <div class="stat-change" id="campaigns-change">Currently running</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Invoices</div>
                    <div class="stat-value" id="pending-invoices">‚Äî</div>
                    <div class="stat-change">Awaiting payment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Capacity Used</div>
                    <div class="stat-value" id="capacity-pct">‚Äî</div>
                    <div class="stat-change" id="capacity-change">of 120 units</div>
                </div>
            </div>

            <!-- CAPACITY GAUGE (mini) -->
            <div style="background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:1.5rem;margin-bottom:1.5rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="margin:0;font-size:1rem;color:#FF6600;">üì° BROADCAST CAPACITY ‚Äî TODAY</h3>
                    <button onclick="showPage('capacity')" style="background:transparent;border:1px solid #FF6600;color:#FF6600;padding:0.3rem 0.8rem;border-radius:4px;cursor:pointer;font-size:0.8rem;">Full View ‚Üí</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1rem;">
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:900;color:#FF6600;" id="dash-cap-used">‚Äî</div>
                        <div style="font-size:0.75rem;color:#999;">Units Used</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:900;color:#00cc44;" id="dash-cap-free">‚Äî</div>
                        <div style="font-size:0.75rem;color:#999;">Units Free</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:900;color:#4488ff;" id="dash-multi-count">‚Äî</div>
                        <div style="font-size:0.75rem;color:#999;">Multi-Mux</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:900;color:#aa44ff;" id="dash-single-count">‚Äî</div>
                        <div style="font-size:0.75rem;color:#999;">Single-Mux</div>
                    </div>
                </div>
                <!-- Capacity bar -->
                <div style="background:#000;border-radius:4px;height:12px;overflow:hidden;">
                    <div id="dash-cap-bar" style="height:100%;background:linear-gradient(90deg,#FF6600,#FF9933);border-radius:4px;transition:width 0.8s ease;width:0%;"></div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:0.3rem;font-size:0.75rem;color:#666;">
                    <span>0</span><span id="dash-toh-label">TOH: ‚Äî</span><span>120</span>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 1rem;">Revenue Trend</h3>
                <canvas id="revenue-chart" height="80"></canvas>
            </div>

            <div>
                <h3 style="margin-bottom: 1rem;">Recent Bookings</h3>
                <table id="recent-bookings-table">
                    <thead>
                        <tr><th>Date</th><th>Customer</th><th>Package</th><th>Mux</th><th>Amount</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- BROADCAST CAPACITY PAGE -->
        <div id="capacity" class="page">
            <div class="header">
                <h2>Broadcast Capacity</h2>
                <p style="color:#999;">Live view of your 120-unit mux capacity across all 3 DAB+ multiplexes</p>
            </div>

            <!-- Main capacity gauge -->
            <div style="background:#1a1a1a;border:2px solid #FF6600;border-radius:12px;padding:2rem;margin-bottom:2rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                    <h3 style="margin:0;color:#FF6600;font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:0.1em;">TOTAL MUX CAPACITY</h3>
                    <div id="toh-badge" style="padding:0.4rem 1rem;border-radius:20px;font-size:0.85rem;font-weight:700;"></div>
                </div>

                <!-- Big number -->
                <div style="text-align:center;margin-bottom:1.5rem;">
                    <span id="cap-used-big" style="font-size:5rem;font-weight:900;color:#FF6600;line-height:1;">‚Äî</span>
                    <span style="font-size:2rem;color:#666;"> / 120</span>
                    <div style="color:#999;margin-top:0.5rem;" id="cap-pct-text">Loading...</div>
                </div>

                <!-- Full capacity bar -->
                <div style="background:#000;border-radius:6px;height:24px;overflow:hidden;margin-bottom:0.5rem;">
                    <div id="cap-bar-main" style="height:100%;background:linear-gradient(90deg,#00cc44,#FF6600,#cc0000);border-radius:6px;transition:width 1s ease;width:0%;"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:#666;margin-bottom:1.5rem;">
                    <span>Empty</span>
                    <span>50% ‚Äî 60 units</span>
                    <span>Full ‚Äî 120 units</span>
                </div>

                <!-- Stats row -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;">
                    <div style="background:#000;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:2rem;font-weight:900;color:#4488ff;" id="cap-multi">‚Äî</div>
                        <div style="color:#999;font-size:0.8rem;margin-top:0.3rem;">Multi-Mux campaigns</div>
                        <div style="color:#4488ff;font-size:0.75rem;" id="cap-multi-units">‚Äî units (√ó3 each)</div>
                    </div>
                    <div style="background:#000;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:2rem;font-weight:900;color:#aa44ff;" id="cap-single">‚Äî</div>
                        <div style="color:#999;font-size:0.8rem;margin-top:0.3rem;">Single-Mux campaigns</div>
                        <div style="color:#aa44ff;font-size:0.75rem;" id="cap-single-units">‚Äî units (√ó1 each)</div>
                    </div>
                    <div style="background:#000;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:2rem;font-weight:900;color:#FFD700;" id="cap-toh">‚Äî</div>
                        <div style="color:#999;font-size:0.8rem;margin-top:0.3rem;">Top of Hour</div>
                        <div style="color:#FFD700;font-size:0.75rem;" id="cap-toh-status">Checking...</div>
                    </div>
                </div>
            </div>

            <!-- Per-mux breakdown (single mux only) -->
            <div style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
                <h3 style="color:#FF6600;margin-bottom:1.5rem;">Single-Mux Breakdown</h3>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;" id="mux-breakdown">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- How many more can I sell? -->
            <div style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
                <h3 style="color:#FF6600;margin-bottom:1rem;">Headroom ‚Äî How Many More Can You Sell?</h3>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
                    <div style="background:#000;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:900;color:#4488ff;" id="headroom-multi">‚Äî</div>
                        <div style="color:#999;font-size:0.85rem;">More multi-mux campaigns</div>
                    </div>
                    <div style="background:#000;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:900;color:#aa44ff;" id="headroom-single">‚Äî</div>
                        <div style="color:#999;font-size:0.85rem;">More single-mux campaigns</div>
                    </div>
                    <div style="background:#000;border-radius:8px;padding:1rem;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:900;color:#FFD700;" id="headroom-toh">‚Äî</div>
                        <div style="color:#999;font-size:0.85rem;">Top of Hour available</div>
                    </div>
                </div>
            </div>

            <!-- Active campaigns table -->
            <div>
                <h3 style="margin-bottom:1rem;">Active &amp; Approved Campaigns</h3>
                <table id="capacity-campaigns-table">
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Type</th>
                            <th>Mux Area</th>
                            <th>Weight</th>
                            <th>Dates</th>
                            <th>Plays</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="header">
                <h2>Website Analytics</h2>
                <p style="color: #999;">Traffic, sessions, and user behavior</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Visitors (30d)</div>
                    <div class="stat-value" id="total-visitors">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Total Sessions</div>
                    <div class="stat-value" id="total-sessions">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Avg Session Duration</div>
                    <div class="stat-value" id="avg-duration">0:00</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Pages Per Session</div>
                    <div class="stat-value" id="pages-per-session">0</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem;">Traffic Over Time</h3>
                <canvas id="traffic-chart" height="80"></canvas>
            </div>
            
            <div>
                <h3 style="margin-bottom: 1rem;">Top Pages</h3>
                <table id="top-pages-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Views</th>
                            <th>Unique Visitors</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Bookings Page -->
        <div id="bookings" class="page">
            <div class="header">
                <h2>Bookings</h2>
                <button onclick="showNewBookingModal()">+ New Booking</button>
            </div>
            
            <table id="bookings-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Package</th>
                        <th>Campaign Dates</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Invoices Page -->
        <div id="invoices" class="page">
            <div class="header">
                <h2>Invoices</h2>
                <button onclick="exportInvoices()">üì• Export CSV</button>
            </div>
            
            <table id="invoices-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Issued</th>
                        <th>Due</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Customers Page -->
        <div id="customers" class="page">
            <div class="header">
                <h2>Customers</h2>
                <button onclick="exportCustomers()">üì• Export CSV</button>
            </div>
            
            <table id="customers-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Total Spent</th>
                        <th>Bookings</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Discounts Page -->
        <div id="discounts" class="page">
            <div class="header">
                <h2>Discount Codes</h2>
                <button onclick="showNewDiscountModal()">+ New Discount</button>
            </div>
            
            <h3 style="margin: 2rem 0 1rem;">Pending Approval</h3>
            <table id="pending-discounts-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Type</th>
                        <th>Value</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
            
            <h3 style="margin: 2rem 0 1rem;">All Discounts</h3>
            <table id="all-discounts-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Type</th>
                        <th>Value</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Approved</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Emails Page -->
        <div id="emails" class="page">
            <div class="header">
                <h2>Email Customers</h2>
            </div>
            
            <div style="max-width: 800px;">
                <form id="email-form">
                    <div class="form-group">
                        <label>To</label>
                        <select id="email-to" required>
                            <option value="">Select customer...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="email-subject" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="email-body" rows="10" required></textarea>
                    </div>
                    
                    <button type="submit">Send Email</button>
                </form>
            </div>
            
            <h3 style="margin: 2rem 0 1rem;">Email History</h3>
            <table id="email-log-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>To</th>
                        <th>Subject</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
    </div>
    
    <!-- Modals -->
    <div id="discount-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('discount-modal')">&times;</span>
                <h3>Create Discount Code</h3>
            </div>
            <form id="create-discount-form">
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="discount-code" required placeholder="e.g., SPRING50">
                </div>
                
                <div class="form-group">
                    <label>Type</label>
                    <select id="discount-type" required>
                        <option value="">Select...</option>
                        <option value="fixed">Fixed Amount (¬£)</option>
                        <option value="percent">Percentage (%)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Value</label>
                    <input type="number" id="discount-value" required placeholder="50">
                </div>
                
                <div class="form-group">
                    <label>Note</label>
                    <input type="text" id="discount-note" placeholder="e.g., Spring promotion">
                </div>
                
                <button type="submit">Create Discount</button>
            </form>
        </div>
    </div>
    
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('payment-modal')">&times;</span>
                <h3>Mark Invoice Paid</h3>
            </div>
            <form id="mark-paid-form">
                <input type="hidden" id="payment-invoice-id">
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="payment-method" required>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="stripe">Stripe</option>
                        <option value="cash">Cash</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Payment Reference</label>
                    <input type="text" id="payment-reference" required placeholder="e.g., TRF123456">
                </div>
                
                <button type="submit">Mark as Paid</button>
            </form>
        </div>
    </div>
    
    <script>
    // ================================================================
    // ROCK.SCOT ADMIN DASHBOARD ‚Äî FULL IMPLEMENTATION
    // Broadcast capacity tracking + all CRM functions
    // ================================================================

    const SUPABASE_URL          = 'https://pwzeapvopeeoahpyicdm.supabase.co';
    const SUPABASE_SERVICE_ROLE = 'YOUR_SERVICE_ROLE_KEY'; // ‚ö†Ô∏è Supabase ‚Üí Settings ‚Üí API
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);

    // ‚îÄ‚îÄ BROADCAST CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MAX_CAPACITY   = 120;
    const WEIGHT_MULTI   = 3;
    const WEIGHT_SINGLE  = 1;
    const WEIGHT_TOH     = 3;

    // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(pageId)?.classList.add('active');
        event.currentTarget?.classList.add('active');
        loadPageData(pageId);
    }

    function loadPageData(id) {
        ({
            dashboard: loadDashboard,
            capacity:  loadCapacity,
            analytics: loadAnalytics,
            bookings:  loadBookings,
            invoices:  loadInvoices,
            customers: loadCustomers,
            discounts: loadDiscounts,
        }[id] || (() => {}))();
    }

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const fmt = (p) => '¬£' + (p / 100).toLocaleString('en-GB', { minimumFractionDigits: 2 });
    const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-GB') : '‚Äî';
    const muxLabel = (type, sel) => ({
        multi:  'All 3 Mux',
        toh:    'TOH ‚Äî All 3',
        single: sel ? sel.replace('_',' ').replace(/\w/g, l => l.toUpperCase()) : 'Single',
    }[type] || type);

    function statusBadge(s) {
        const colours = { active:'#00cc44', approved:'#4488ff', pending:'#FF6600',
                          completed:'#666', cancelled:'#aa0000', paid:'#00cc44',
                          sent:'#FF6600', draft:'#666', overdue:'#cc0000' };
        const c = colours[s] || '#999';
        return `<span style="background:${c}20;color:${c};border:1px solid ${c};padding:0.2rem 0.6rem;border-radius:12px;font-size:0.78rem;font-weight:700;text-transform:uppercase;">${s}</span>`;
    }

    function tableRows(tbody, rows) {
        document.querySelector(tbody + ' tbody').innerHTML = rows ||
            '<tr><td colspan="99" style="text-align:center;color:#666;padding:2rem;">No records found</td></tr>';
    }

    // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDashboard() {
        // Revenue
        const { data: invData } = await supabase
            .from('invoices').select('total_pence,status,paid_at');
        const totalRev  = (invData || []).filter(i => i.status === 'paid').reduce((s,i) => s + i.total_pence, 0);
        const pending   = (invData || []).filter(i => i.status === 'sent').length;
        document.getElementById('total-revenue').textContent    = fmt(totalRev);
        document.getElementById('pending-invoices').textContent = pending;

        // Active campaigns
        const today = new Date().toISOString().split('T')[0];
        const { data: camps, count: campCount } = await supabase
            .from('campaigns').select('*', { count: 'exact' })
            .in('status', ['active','approved'])
            .lte('start_date', today).gte('end_date', today);
        document.getElementById('active-bookings').textContent = campCount || 0;

        // Capacity mini gauge
        const { data: capRaw } = await supabase.rpc('capacity_summary');
        const cap = typeof capRaw === 'string' ? JSON.parse(capRaw) : capRaw;
        if (cap) {
            const used = cap.active_weight_used || 0;
            const free = MAX_CAPACITY - used;
            const pct  = Math.round(used / MAX_CAPACITY * 100);
            document.getElementById('dash-cap-used').textContent = used;
            document.getElementById('dash-cap-free').textContent = free;
            document.getElementById('dash-multi-count').textContent = cap.active_multi || 0;
            document.getElementById('dash-single-count').textContent = cap.active_single || 0;
            document.getElementById('dash-cap-bar').style.width = pct + '%';
            document.getElementById('capacity-pct').textContent = pct + '%';
            document.getElementById('capacity-change').textContent = `${used} of 120 units`;
            document.getElementById('dash-toh-label').textContent =
                cap.toh_sold ? 'üåü TOH: Sold' : 'TOH: Available';
        }

        // Recent bookings
        const { data: recent } = await supabase
            .from('advertising_leads').select('*')
            .order('created_at', { ascending: false }).limit(10);
        tableRows('#recent-bookings-table', (recent || []).map(r => `
            <tr>
                <td>${fmtDate(r.created_at)}</td>
                <td><strong>${r.first_name} ${r.last_name}</strong><br><span style="color:#999;font-size:0.8rem;">${r.company || ''}</span></td>
                <td>${r.product_name}</td>
                <td>${muxLabel(r.mux_type, r.selected_mux)}</td>
                <td>${fmt(r.final_price_pence || r.product_net_pence)}</td>
                <td>
                    <button onclick="approveCampaign('${r.id}')" style="background:#FF6600;color:white;border:none;padding:0.3rem 0.8rem;border-radius:4px;cursor:pointer;font-size:0.8rem;">Approve</button>
                </td>
            </tr>`).join('') || null);

        // Revenue chart
        const monthly = {};
        (invData || []).filter(i => i.status === 'paid' && i.paid_at).forEach(i => {
            const mo = i.paid_at.substring(0, 7);
            monthly[mo] = (monthly[mo] || 0) + i.total_pence;
        });
        const labels = Object.keys(monthly).sort().slice(-6);
        const values = labels.map(k => monthly[k] / 100);
        const ctx = document.getElementById('revenue-chart')?.getContext('2d');
        if (ctx && window.Chart) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ label: 'Revenue (¬£)', data: values,
                        backgroundColor: 'rgba(255,102,0,0.7)',
                        borderColor: '#FF6600', borderWidth: 2 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } },
                    scales: { y: { ticks: { color: '#999' }, grid: { color: '#333' } },
                              x: { ticks: { color: '#999' }, grid: { color: '#333' } } } }
            });
        }
    }

    // ‚îÄ‚îÄ BROADCAST CAPACITY PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCapacity() {
        const { data: capRaw } = await supabase.rpc('capacity_summary');
        const cap = typeof capRaw === 'string' ? JSON.parse(capRaw) : (capRaw || {});

        const used   = cap.active_weight_used || 0;
        const free   = MAX_CAPACITY - used;
        const pct    = Math.round(used / MAX_CAPACITY * 100);
        const multi  = cap.active_multi  || 0;
        const single = cap.active_single || 0;
        const toh    = cap.active_toh    || 0;
        const tohSold = cap.toh_sold || false;

        // Big gauge
        document.getElementById('cap-used-big').textContent = used;
        document.getElementById('cap-pct-text').textContent =
            `${pct}% capacity used ‚Äî ${free} units remaining`;
        document.getElementById('cap-bar-main').style.width = pct + '%';
        document.getElementById('cap-bar-main').style.background =
            pct < 50  ? 'linear-gradient(90deg,#00cc44,#00cc44)' :
            pct < 80  ? 'linear-gradient(90deg,#00cc44,#FF6600)' :
                        'linear-gradient(90deg,#FF6600,#cc0000)';

        // TOH badge
        const tohBadge = document.getElementById('toh-badge');
        tohBadge.textContent   = tohSold ? 'üåü TOP OF HOUR: SOLD' : '‚≠ï TOP OF HOUR: AVAILABLE';
        tohBadge.style.background = tohSold ? '#2a2000' : '#002a00';
        tohBadge.style.color      = tohSold ? '#FFD700' : '#00cc44';
        tohBadge.style.border     = `1px solid ${tohSold ? '#FFD700' : '#00cc44'}`;

        // Campaign counts
        document.getElementById('cap-multi').textContent  = multi;
        document.getElementById('cap-single').textContent = single;
        document.getElementById('cap-toh').textContent    = toh;
        document.getElementById('cap-multi-units').textContent  = `${multi * WEIGHT_MULTI} units (√ó3 each)`;
        document.getElementById('cap-single-units').textContent = `${single * WEIGHT_SINGLE} units (√ó1 each)`;
        document.getElementById('cap-toh-status').textContent   = tohSold ? 'Sold ‚úì' : 'Available';

        // Headroom
        document.getElementById('headroom-multi').textContent  = cap.max_additional_multi  || Math.floor(free / 3);
        document.getElementById('headroom-single').textContent = cap.max_additional_single || free;
        document.getElementById('headroom-toh').textContent    = tohSold ? '0' : '1';

        // Per-mux breakdown
        const muxes = [
            { key: 'inverclyde',      label: 'Inverclyde',       count: cap.active_single_inverclyde     || 0 },
            { key: 'north_ayrshire',  label: 'North Ayrshire',   count: cap.active_single_north_ayrshire || 0 },
            { key: 'south_lanarkshire', label: 'South Lanarkshire', count: cap.active_single_s_lanarkshire || 0 },
        ];
        document.getElementById('mux-breakdown').innerHTML = muxes.map(m => `
            <div style="background:#000;border-radius:8px;padding:1.25rem;text-align:center;">
                <div style="font-size:2rem;font-weight:900;color:#aa44ff;">${m.count}</div>
                <div style="color:#ccc;font-weight:700;margin:0.25rem 0;">${m.label}</div>
                <div style="color:#666;font-size:0.8rem;">${m.count} single-mux campaign${m.count !== 1 ? 's' : ''}</div>
                <div style="background:#1a1a1a;border-radius:4px;height:6px;margin-top:0.75rem;overflow:hidden;">
                    <div style="height:100%;background:#aa44ff;width:${Math.min(100, m.count / 40 * 100)}%;transition:width 0.8s;"></div>
                </div>
                <div style="font-size:0.75rem;color:#666;margin-top:0.25rem;">${m.count} / 40</div>
            </div>`).join('');

        // Active campaigns table
        const today = new Date().toISOString().split('T')[0];
        const { data: camps } = await supabase
            .from('campaigns').select('*')
            .in('status', ['active','approved'])
            .order('start_date');
        tableRows('#capacity-campaigns-table', (camps || []).map(c => `
            <tr>
                <td><strong>${c.name}</strong></td>
                <td><span style="color:${c.mux_type==='multi'?'#4488ff':c.mux_type==='toh'?'#FFD700':'#aa44ff'}">${c.mux_type.toUpperCase()}</span></td>
                <td>${muxLabel(c.mux_type, c.selected_mux)}</td>
                <td style="text-align:center;font-weight:700;color:#FF6600;">√ó${c.mux_weight}</td>
                <td>${fmtDate(c.start_date)} ‚Üí ${fmtDate(c.end_date)}</td>
                <td>${c.plays_completed} / ${c.total_plays}</td>
                <td>${statusBadge(c.status)}</td>
            </tr>`).join('') || null);
    }

    // ‚îÄ‚îÄ BOOKINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadBookings() {
        const { data } = await supabase
            .from('advertising_leads').select('*')
            .order('created_at', { ascending: false });
        tableRows('#bookings-table', (data || []).map(r => `
            <tr>
                <td>${fmtDate(r.created_at)}</td>
                <td><strong>${r.first_name} ${r.last_name}</strong><br><span style="color:#999;font-size:0.8rem;">${r.email}</span></td>
                <td>${r.product_name}</td>
                <td>${muxLabel(r.mux_type, r.selected_mux)}<br><span style="color:#666;font-size:0.8rem;">Wt: √ó${r.mux_weight||'?'}</span></td>
                <td>${fmtDate(r.start_date)}</td>
                <td>${fmt(r.final_price_pence || r.product_net_pence)}</td>
                <td>
                    <button onclick="approveCampaign('${r.id}')" style="background:#FF6600;color:white;border:none;padding:0.3rem 0.8rem;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-right:0.3rem;">‚úì Approve</button>
                    <button onclick="generateInvoice('${r.id}')" style="background:#333;color:white;border:none;padding:0.3rem 0.8rem;border-radius:4px;cursor:pointer;font-size:0.8rem;">Invoice</button>
                </td>
            </tr>`).join('') || null);
    }

    // ‚îÄ‚îÄ INVOICES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadInvoices() {
        const { data } = await supabase
            .from('invoices').select('*, booking:advertising_leads(first_name,last_name,email,product_name)')
            .order('created_at', { ascending: false });
        tableRows('#invoices-table', (data || []).map(i => `
            <tr>
                <td><strong>${i.invoice_number || '‚Äî'}</strong></td>
                <td>${i.booking ? i.booking.first_name + ' ' + i.booking.last_name : '‚Äî'}<br><span style="color:#999;font-size:0.8rem;">${i.booking?.email || ''}</span></td>
                <td>${fmt(i.total_pence)}</td>
                <td>${fmtDate(i.due_date)}</td>
                <td>${statusBadge(i.status)}</td>
                <td>
                    ${i.pdf_url ? `<a href="${i.pdf_url}" target="_blank" style="color:#FF6600;font-size:0.8rem;">Download</a>` : ''}
                    ${i.status === 'sent' ? `<button onclick="markPaid('${i.id}')" style="background:#00cc44;color:white;border:none;padding:0.2rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.75rem;margin-left:0.3rem;">Mark Paid</button>` : ''}
                </td>
            </tr>`).join('') || null);
    }

    // ‚îÄ‚îÄ CUSTOMERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCustomers() {
        const { data } = await supabase
            .from('user_profiles').select('*, auth_user:id').order('created_at', { ascending: false });
        tableRows('#customers-table', (data || []).map(c => `
            <tr>
                <td><strong>${c.first_name || ''} ${c.last_name || ''}</strong></td>
                <td>${c.company_name || '‚Äî'}</td>
                <td><span style="color:${c.role==='admin'?'#FF6600':'#999'}">${c.role}</span></td>
                <td>${fmtDate(c.created_at)}</td>
                <td>${fmtDate(c.last_login_at)}</td>
                <td>${c.login_count}</td>
            </tr>`).join('') || null);
    }

    // ‚îÄ‚îÄ DISCOUNTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDiscounts() {
        const { data: pending } = await supabase.rpc('get_pending_discounts');
        tableRows('#pending-discounts-table', (pending || []).map(d => `
            <tr>
                <td><strong>${d.code}</strong></td>
                <td>${d.amount_pence ? fmt(d.amount_pence) : d.percent_off + '%'}</td>
                <td>${fmtDate(d.created_at)}</td>
                <td>${d.note || '‚Äî'}</td>
                <td>
                    <button onclick="approveDiscount('${d.id}')" style="background:#00cc44;color:white;border:none;padding:0.3rem 0.8rem;border-radius:4px;cursor:pointer;font-size:0.8rem;">Approve</button>
                    <button onclick="rejectDiscount('${d.id}')"  style="background:#cc0000;color:white;border:none;padding:0.3rem 0.8rem;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-left:0.3rem;">Reject</button>
                </td>
            </tr>`).join('') || null);

        const { data: all } = await supabase.from('discounts').select('*').order('created_at', { ascending: false });
        tableRows('#all-discounts-table', (all || []).map(d => `
            <tr>
                <td><strong>${d.code}</strong></td>
                <td>${d.amount_pence ? fmt(d.amount_pence) : d.percent_off + '%'}</td>
                <td>${d.use_count} / ${d.max_uses || '‚àû'}</td>
                <td>${fmtDate(d.expires_at) || 'Never'}</td>
                <td>${d.approved_at ? statusBadge('paid') : statusBadge('pending')}</td>
                <td>${d.is_active ? '‚úÖ' : '‚ùå'}</td>
            </tr>`).join('') || null);
    }

    // ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadAnalytics() {
        const since = new Date(Date.now() - 30 * 86400000).toISOString();
        const { count: visitors } = await supabase.from('page_views')
            .select('*', { count: 'exact', head: true }).gte('created_at', since);
        const { count: sessions } = await supabase.from('sessions')
            .select('*', { count: 'exact', head: true }).gte('created_at', since);
        document.getElementById('total-visitors').textContent = visitors || 0;
        document.getElementById('total-sessions').textContent = sessions || 0;

        const { data: pages } = await supabase.from('page_views')
            .select('page_path').gte('created_at', since);
        const pageCounts = {};
        (pages || []).forEach(p => { pageCounts[p.page_path] = (pageCounts[p.page_path] || 0) + 1; });
        const topPages = Object.entries(pageCounts).sort((a,b) => b[1]-a[1]).slice(0,10);
        tableRows('#top-pages-table', topPages.map(([path, count]) => `
            <tr><td>${path}</td><td style="text-align:right;color:#FF6600;">${count}</td></tr>`).join(''));
    }

    // ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function approveCampaign(bookingId) {
        if (!confirm('Approve this campaign?')) return;
        const { data: booking } = await supabase
            .from('advertising_leads').select('*').eq('id', bookingId).single();
        if (!booking) return alert('Booking not found');

        // Check capacity first
        const endDate = new Date(booking.start_date || new Date());
        endDate.setDate(endDate.getDate() + (booking.campaign_length_days || 28));
        const { data: capRaw } = await supabase.rpc('check_capacity', {
            p_mux_type:   booking.mux_type || 'multi',
            p_start_date: booking.start_date || new Date().toISOString().split('T')[0],
            p_end_date:   endDate.toISOString().split('T')[0],
        });
        const cap = typeof capRaw === 'string' ? JSON.parse(capRaw) : capRaw;
        if (cap && !cap.can_approve) {
            return alert(`Cannot approve: ${cap.reason}

Capacity used: ${cap.capacity_used}/120`);
        }

        // Create campaign
        const { error } = await supabase.from('campaigns').insert([{
            booking_id:    booking.id,
            user_id:       booking.user_id,
            name:          `${booking.company || booking.first_name} ‚Äî ${booking.product_name}`,
            start_date:    booking.start_date || new Date().toISOString().split('T')[0],
            end_date:      endDate.toISOString().split('T')[0],
            package_type:  booking.product_id || 'multi_regional',
            mux_type:      booking.mux_type || 'multi',
            mux_weight:    booking.mux_weight || 3,
            selected_mux:  booking.selected_mux || null,
            total_plays:   booking.mux_type === 'toh' ? 672 : 134,
            status:        'approved',
        }]);
        if (error) return alert('Error: ' + error.message);
        alert('‚úÖ Campaign approved! Capacity updated.');
        loadDashboard();
    }

    async function generateInvoice(bookingId) {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/create-revolut-link`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_SERVICE_ROLE },
            body: JSON.stringify({ booking_id: bookingId }),
        });
        const result = await res.json();
        if (res.ok) {
            alert(`‚úÖ Invoice ${result.invoice_number} created!
${result.revolut_payment_link ? 'Payment link sent.' : 'Bank transfer details sent.'}`);
            loadInvoices();
        } else {
            alert('Error: ' + result.error);
        }
    }

    async function markPaid(invoiceId) {
        if (!confirm('Mark this invoice as paid?')) return;
        await supabase.from('invoices').update({ status: 'paid', paid_at: new Date().toISOString() }).eq('id', invoiceId);
        loadInvoices();
    }

    async function approveDiscount(discountId) {
        const { data: { session } } = await supabase.auth.getSession();
        const userId = session?.user?.id;
        if (!userId) return alert('Not logged in');
        const { error } = await supabase.rpc('approve_discount', {
            p_discount_id: discountId, p_approved_by: userId
        });
        if (error) alert('Error: ' + error.message);
        else { alert('‚úÖ Discount approved!'); loadDiscounts(); }
    }

    async function rejectDiscount(discountId) {
        await supabase.from('discounts').update({ is_active: false }).eq('id', discountId);
        loadDiscounts();
    }

    // Create discount modal
    document.getElementById('create-discount-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code  = document.getElementById('discount-code').value.trim().toUpperCase();
        const type  = document.getElementById('discount-type').value;
        const value = parseFloat(document.getElementById('discount-value').value);
        const note  = document.getElementById('discount-note').value;
        const { data: { session } } = await supabase.auth.getSession();
        const { error } = await supabase.rpc('create_discount_code', {
            p_code:         code,
            p_amount_pence: type === 'fixed' ? Math.round(value * 100) : null,
            p_percent_off:  type === 'percent' ? Math.round(value) : null,
            p_created_by:   session?.user?.id,
            p_note:         note,
        });
        if (error) alert('Error: ' + error.message);
        else { alert('‚úÖ Discount code created! Awaiting approval.'); closeModal('discount-modal'); loadDiscounts(); }
    });

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    function showNewDiscountModal() {
        document.getElementById('discount-modal').style.display = 'flex';
    }

    // ‚îÄ‚îÄ INITIALISE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    loadDashboard();
    </script>
    
</body>
</html>
